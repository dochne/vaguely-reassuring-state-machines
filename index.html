<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vaguely reassuring state machines</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="/styles.css" rel="stylesheet">
  <script src="/script.js"></script>
</head>
<body>
    <div class="container">
      <h2 class="m-4 text-center">vaguely reassuring state machines</h2>
      <div class="loading show text-center" style="padding-top: 40px">
        <div class="spinner-border" role="status" style="height: 40px; width: 40px;"></div>
      </div>
      <div class="content row">
        <div class="col-md-3">
          <div class="list-group" id="sidebar"></div>
        </div>
        <div class="col-md-9">
          <div class="card" id="card">
            <div class="card-header">
              <!-- <div class="row">
                <div class="col-md-10"> -->
                  <h3 class="main-header mb-0"></h3>
                <!-- </div>
                <div class="col-md-2 text-end">
                  <select class="form-control text-end">
                    <option>Latest</option>
                    <option>Latest</option>
                  </select>
                </div>
              </div> -->
              
            </div>
            
            <div class="card-body">
              <div class="text-center">
                <a class="main-link">
                  <img class="card-image main-image" src="https://cdn.bsky.app/img/feed_fullsize/plain/did:plc:ta7md6dgr25hz4kztzx2v54o/bafkreiasid45hn2toao6xdtyp53lnub7xf43ixxnbo3umbjq55xwvo4tnm@jpeg" style="height: 300px"/>
                </a>
              </div>
              <div class="mb-3" style="margin-top: 5px">
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text">/^</span>
                  </div>
                  <input type="text" class="form-control is-invalid" id="regex" placeholder="regex: e.g. ü§ç+">
                  <div class="input-group-append">
                    <span class="input-group-text">$/</span>
                  </div>
                </div>
                <div class="invalid-feedback" id="regex-feedback">
                  Looks good!
                </div>                
              </div>

              <div class="mb-3" id="valid-examples-container">
                <label for="valid" class="form-label">Valid patterns</label>
                <div class="textarea-container">
                  <div class="test-results" id="valid-results"></div>
                  <textarea id="valid" placeholder="list of valid patterns - e.g. ü§çü§çü§çüñ§"></textarea>
                </div>
              </div>

              <div class="mb-3" id="invalid-examples-container">
                <label for="invalid" class="form-label">Invalid patterns</label>
                <div class="textarea-container">
                  <div class="test-results" id="invalid-results"></div>
                  <textarea id="invalid" placeholder="list of invalid patterns - e.g. üñ§üñ§ü§çü§çü§çüñ§"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top: 20px; margin-bottom: 20px">
            <div class="card-header">FAQ</div>
            <div class="card-body">
              <strong>What is this? What am I trying to do?</strong>
              <p>The image is a representation of a finite state machine. The aim is to craft a regular expression that will match the state machine.</p>
              <p>These should start at the left hand side, and should only be valid if they terminate at a double circle.</p>

              <strong>Why am I trying to do this?</strong>
              <p>Well, because they've vaguely reassuring somehow. Let me know if you work out how they pull this off</p>

              <strong>What's the benefit of this page?</strong>
              <p><a href="https://bsky.app/profile/dochne.com/post/3lcofm32b4k2f">It can be tricky</a> not to screw it up - so it's nice to have an easy way to write a test suite</p>

              <strong>How can I use it?</strong>
              <p>Add example patterns that should be valid to the valid box and invalid to the invalid and start writing your regex!</p>

              <strong>...uch, this isn't PCRE!</strong>
              <p>That's not a question!</p>

              <strong>Who runs vaguely reassuring state machines?</strong>
              <p><a href="https://bsky.app/profile/katef.bsky.social">Kate!</a></p>
              
              <strong>Who made this page?</strong>
              <p>I'm <a href="https://bsky.app/profile/dochne.com">Doug</a>!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>

      const regexInput = document.getElementById("regex");
      const regexFeedback = document.getElementById("regex-feedback");
      const validInput = document.getElementById("valid");
      const validResults = document.getElementById("valid-results");
      const invalidInput = document.getElementById("invalid");
      const invalidResults = document.getElementById("invalid-results");
      
      const actor = "did:plc:ta7md6dgr25hz4kztzx2v54o";
      
      (async () => {
        // return;
          const {feed} = await cache("state", async () => {
              const url = `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${actor}`;
              const response = await fetch(url);
              return await response.json();
          }, 300); // we'll try and get a fresh set every 5 minutes

          console.log(feed);
          document.querySelector(".loading").classList.remove("show");
          document.querySelector(".content").classList.add("show");

          const currentPost = getCurrentPost(feed);
          console.log("CurrentPost", currentPost);
          document.getElementById("sidebar").innerHTML = buildSidebar(feed, currentPost);
          buildCard(currentPost);
          load(currentPost.cid);
          if (regexInput.value.length > 0) {
            runTests();
          }

          function runTests(){
            validResults.scrollTop = validInput.scrollTop;
            invalidResults.scrollTop = invalidInput.scrollTop;
            save(currentPost.cid);

            let isInvalid = false;
            try{
              const input = regexInput.value.replaceAll(" ", "");
              const regexp = new RegExp(`^${input}$`, 'u')
              validResults.innerHTML = validInput.value.split("\n").map(value => {
                if (value === '') {
                  return '';
                }
                // console.log("Value", value, "matches", value.match(regexp));
                let matches = value.match(regexp);
                let title = matches ? `Matched '${matches[0]}'` : ''
                return `<span title="${title}">${matches && matches[0] === value ? "‚úÖ" : "‚ùå"}</span>`;
              }).join("<br>")
              invalidResults.innerHTML = invalidInput.value.split("\n").map(value => {
                if (value === '') {
                  return '';
                }
                let matches = value.match(regexp);
                let title = matches ? `Matched '${matches[0]}'` : ''
                // console.log("InvalidInput", value, "Matches", value.match(regexp), "Pass?", regexp[0] !== value)
                return `<span title="${title}">${((matches && matches[0] === value) ? "‚ùå" :  "‚úÖ")}</span>`;
              }).join("<br>");
            } catch (error) {
              isInvalid = error;
              console.log("error", error);
            }

            if (isInvalid) {
              regexInput.classList.add("is-invalid")
              regexFeedback.classList.add("show")
              regexFeedback.innerText = isInvalid;
            } else {
              regexInput.classList.remove("is-invalid")
              regexFeedback.classList.remove("show")
            }
          }
          
          regexInput.onkeyup = () => runTests();
          validInput.onkeyup = () => runTests();
          validInput.onkeypress = () => validResults.scrollTop = validInput.scrollTop; // enter
          validInput.onscroll = () => validResults.scrollTop = validInput.scrollTop;
          invalidInput.onkeyup = () => runTests();
          invalidInput.onkeypress = () => invalidResults.scrollTop = invalidInput.scrollTop; // enter
          invalidInput.onscroll = () => invalidResults.scrollTop = invalidInput.scrollTop;

      })();
  </script>

</body>
</html>